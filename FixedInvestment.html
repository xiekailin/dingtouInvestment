<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>定投记录工具</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            background-color: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select {
            width: 100%;
            padding: 10px;
            box-sizing: border-box;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 20px 0;
        }
        button {
            padding: 10px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #45a049;
        }
        button.secondary {
            background-color: #2196F3;
        }
        button.secondary:hover {
            background-color: #0b7dda;
        }
        button.danger {
            background-color: #f44336;
        }
        button.danger:hover {
            background-color: #d32f2f;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
            position: sticky;
            top: 0;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .price-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 15px 0;
            padding: 10px;
            background-color: #e8f5e9;
            border-radius: 4px;
        }
        .current-price {
            font-weight: bold;
            font-size: 1.2em;
            color: #2e7d32;
        }
        .positive {
            color: green;
        }
        .negative {
            color: red;
        }
        .statistics-container {
            margin-top: 30px;
            padding: 15px;
            background-color: #f8f8f8;
            border-radius: 5px;
            box-shadow: 0 0 5px rgba(0,0,0,0.1);
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 15px;
        }
        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background-color: white;
            border-radius: 4px;
            box-shadow: 0 0 3px rgba(0,0,0,0.05);
        }
        .stat-value {
            font-weight: bold;
        }
        .currency-selector {
            margin-bottom: 20px;
        }
        .radio-group {
            display: flex;
            gap: 15px;
        }
        .radio-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .radio-item input[type="radio"] {
            width: auto;
        }
        /* 添加弹窗样式 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: #fff;
            margin: 10% auto;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            width: 80%;
            max-width: 500px;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        .modal-title {
            font-size: 1.2em;
            font-weight: bold;
            margin: 0;
        }
        .close {
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
        }
        .modal-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>定投记录工具</h1>
        
        <div class="currency-selector">
            <label>币种</label>
            <div class="radio-group">
                <div class="radio-item">
                    <input type="radio" id="currency-usd" name="currency" value="USD" checked>
                    <label for="currency-usd">美元 (USD)</label>
                </div>
                <div class="radio-item">
                    <input type="radio" id="currency-cny" name="currency" value="CNY">
                    <label for="currency-cny">人民币 (CNY)</label>
                </div>
            </div>
        </div>
        
        <div class="form-group">
            <label for="date">日期时间</label>
            <input type="datetime-local" id="date" required>
        </div>
        
        <div class="form-group">
            <label for="amount">买入金额 (<span id="currency-symbol">USD</span>)</label>
            <input type="number" id="amount" placeholder="请输入买入金额" step="0.01" min="0" required>
        </div>
        
        <div class="form-group">
            <label for="btcPrice">买入时BTC价格 (<span id="price-currency-symbol">USD</span>)</label>
            <input type="number" id="btcPrice" placeholder="请输入买入时BTC价格" step="0.01" min="0" required>
            <button id="getCurrentPrice" class="secondary" style="width: auto; margin-top: 5px;">获取当前价格</button>
        </div>
        
        <div class="form-group">
            <label for="note">备注</label>
            <input type="text" id="note" placeholder="可选备注">
        </div>
        
        <div class="button-group">
            <button id="saveBtn">保存记录</button>
            <button id="clearBtn" class="danger">清空所有记录</button>
            <button id="exportBtn" class="secondary">导出数据</button>
            <button id="importBtn" class="secondary">导入数据</button>
        </div>
        
        <div class="price-container">
            <div>
                <span>当前BTC价格 (<span id="current-price-currency">USD</span>): </span>
                <span id="currentBtcPrice" class="current-price">--</span>
            </div>
            <button id="refreshPrice" class="secondary">手动刷新价格</button>
            <div class="radio-item">
                <input type="checkbox" id="autoRefresh">
                <label for="autoRefresh">自动更新价格 (每60秒)</label>
            </div>
        </div>
        
        <h2>定投历史记录</h2>
        <table>
            <thead>
                <tr>
                    <th>日期</th>
                    <th>买入金额 (<span class="table-currency">USD</span>)</th>
                    <th>买入时BTC价格 (<span class="table-price-currency">USD</span>)</th>
                    <th>买入数量 (BTC)</th>
                    <th>备注</th>
                    <th>当前价值 (<span class="table-value-currency">USD</span>)</th>
                    <th>收益率 (%)</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody id="recordList">
                <!-- 记录将通过JavaScript动态插入 -->
            </tbody>
        </table>
        
        <div id="statistics" class="statistics-container">
            <h2>投资统计</h2>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-label">总投资额 (<span class="stats-currency">USD</span>):</div>
                    <div id="totalInvestment" class="stat-value">0.00</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">总BTC数量:</div>
                    <div id="totalBtc" class="stat-value">0.00000000</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">当前总价值 (<span class="stats-value-currency">USD</span>):</div>
                    <div id="totalCurrentValue" class="stat-value">0.00</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">总收益 (<span class="stats-profit-currency">USD</span>):</div>
                    <div id="totalProfit" class="stat-value">0.00</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">总收益率 (%):</div>
                    <div id="totalProfitPercentage" class="stat-value">0.00%</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">买入金额均价 (<span class="stats-currency">USD</span>):</div>
                    <div id="averageAmount" class="stat-value">0.00</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">BTC价格均价 (<span class="stats-currency">USD</span>):</div>
                    <div id="averageBtcPrice" class="stat-value">0.00</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">平均收益率 (%):</div>
                    <div id="averageReturnRate" class="stat-value">0.00%</div>
                </div>                
            </div>
        </div>
        
        <!-- 隐藏的文件导入输入 -->
        <input type="file" id="importFile" style="display: none;" accept=".json">

        <!-- 编辑记录的弹窗 -->
        <div id="editRecordModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">编辑记录</h3>
                    <span class="close">&times;</span>
                </div>
                <div class="modal-form">
                    <div class="form-group">
                        <label for="editDate">日期时间</label>
                        <input type="datetime-local" id="editDate" required>
                    </div>
                    <div class="form-group">
                        <label for="editAmount">买入金额 (<span id="edit-currency-symbol">USD</span>)</label>
                        <input type="number" id="editAmount" placeholder="请输入买入金额" step="0.01" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="editBtcPrice">买入时BTC价格 (<span id="edit-price-currency-symbol">USD</span>)</label>
                        <input type="number" id="editBtcPrice" placeholder="请输入买入时BTC价格" step="0.01" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="editNote">备注</label>
                        <input type="text" id="editNote" placeholder="可选备注">
                    </div>
                </div>
                <div class="modal-buttons">
                    <button id="cancelEditBtn" class="danger">取消</button>
                    <button id="saveEditBtn">保存修改</button>
                </div>
                <!-- 隐藏的索引字段，用于标识正在编辑的记录 -->
                <input type="hidden" id="editRecordIndex">
            </div>
        </div>
    </div>

    <script>
        // 获取DOM元素
        const dateInput = document.getElementById('date');
        const amountInput = document.getElementById('amount');
        const btcPriceInput = document.getElementById('btcPrice');
        const noteInput = document.getElementById('note');
        const saveBtn = document.getElementById('saveBtn');
        const clearBtn = document.getElementById('clearBtn');
        const exportBtn = document.getElementById('exportBtn');
        const importBtn = document.getElementById('importBtn');
        const importFile = document.getElementById('importFile');
        const refreshPriceBtn = document.getElementById('refreshPrice');
        const getCurrentPriceBtn = document.getElementById('getCurrentPrice');
        const autoRefreshCheckbox = document.getElementById('autoRefresh');
        const recordList = document.getElementById('recordList');
        const currencyRadios = document.getElementsByName('currency');
        
        // 编辑弹窗相关元素
        const editModal = document.getElementById('editRecordModal');
        const editDateInput = document.getElementById('editDate');
        const editAmountInput = document.getElementById('editAmount');
        const editBtcPriceInput = document.getElementById('editBtcPrice');
        const editNoteInput = document.getElementById('editNote');
        const editRecordIndexInput = document.getElementById('editRecordIndex');
        const saveEditBtn = document.getElementById('saveEditBtn');
        const cancelEditBtn = document.getElementById('cancelEditBtn');
        const closeModalBtn = document.querySelector('#editRecordModal .close');
        
        // 设置当前日期时间为默认值
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        dateInput.value = `${year}-${month}-${day}T${hours}:${minutes}`;
        
        // 汇率转换 (简单示例，实际应用应该使用API获取最新汇率)
        const exchangeRates = {
            USD_TO_CNY: 7.2, // 假设1美元 = 7.2人民币
            CNY_TO_USD: 1/7.2 // 假设1人民币 = 0.139美元
        };
        
        // 当前选择的货币
        let selectedCurrency = 'USD';
        
        // 自动刷新价格的定时器ID
        let autoRefreshIntervalId = null;
        
        // 从localStorage加载记录
        let records = JSON.parse(localStorage.getItem('investmentRecords')) || [];
        
        // 获取最新汇率
        async function fetchExchangeRate() {
            try {
                const response = await fetch('https://open.er-api.com/v6/latest/USD');
                const data = await response.json();
                
                if (data && data.rates && data.rates.CNY) {
                    // 更新汇率
                    exchangeRates.USD_TO_CNY = data.rates.CNY;
                    exchangeRates.CNY_TO_USD = 1 / data.rates.CNY;
                    console.log('汇率更新成功:', exchangeRates);
                    return true;
                } else {
                    console.error('汇率数据格式不正确');
                    return false;
                }
            } catch (error) {
                console.error('获取汇率失败，使用默认汇率:', error);
                return false;
            }
        }
        
        // 监听货币选择变化
        currencyRadios.forEach(radio => {
            radio.addEventListener('change', async function() {
                const oldCurrency = selectedCurrency;
                selectedCurrency = this.value;
                console.log(`货币从 ${oldCurrency} 切换到 ${selectedCurrency}`);
                
                // 更新标签
                updateCurrencyLabels();
                
                // 先获取当前选择货币的BTC价格，再显示记录
                // 这样可以确保在计算当前价值时使用正确的价格
                try {
                    console.log("正在更新BTC价格...");
                    await fetchBtcPrice();
                    console.log("价格更新完成，重新显示记录");
                    displayRecords();
                } catch (error) {
                    console.error("获取价格失败，尝试使用已有价格显示记录");
                    displayRecords();
                }
            });
        });
        
        // 更新所有货币标签
        function updateCurrencyLabels() {
            document.getElementById('currency-symbol').textContent = selectedCurrency;
            document.getElementById('price-currency-symbol').textContent = selectedCurrency;
            document.getElementById('current-price-currency').textContent = selectedCurrency;
            
            // 更新表格中的货币标签
            document.querySelectorAll('.table-currency').forEach(el => {
                el.textContent = selectedCurrency;
            });
            document.querySelectorAll('.table-price-currency').forEach(el => {
                el.textContent = selectedCurrency;
            });
            document.querySelectorAll('.table-value-currency').forEach(el => {
                el.textContent = selectedCurrency;
            });
            
            // 更新统计区域的货币标签
            document.querySelectorAll('.stats-currency').forEach(el => {
                el.textContent = selectedCurrency;
            });
            document.querySelectorAll('.stats-value-currency').forEach(el => {
                el.textContent = selectedCurrency;
            });
            document.querySelectorAll('.stats-profit-currency').forEach(el => {
                el.textContent = selectedCurrency;
            });
        }
        
        // 处理自动刷新价格的切换
        autoRefreshCheckbox.addEventListener('change', function() {
            if (this.checked) {
                // 启用自动刷新 (每60秒)
                autoRefreshIntervalId = setInterval(fetchBtcPrice, 60000);
            } else {
                // 停止自动刷新
                if (autoRefreshIntervalId !== null) {
                    clearInterval(autoRefreshIntervalId);
                    autoRefreshIntervalId = null;
                }
            }
        });
        
        // 获取BTC价格的函数
        async function fetchBtcPrice() {
            try {
                console.log("获取BTC价格，当前货币:", selectedCurrency);
                const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd,cny');
                const data = await response.json();
                
                // 存储两种货币的价格
                const usdPrice = data.bitcoin.usd;
                const cnyPrice = data.bitcoin.cny;
                
                console.log('API返回的BTC价格 - USD:', usdPrice, 'CNY:', cnyPrice);
                
                let price;
                if (selectedCurrency === 'USD') {
                    price = usdPrice;
                } else {
                    price = cnyPrice;
                }
                
                console.log('最终显示的价格:', price, '货币:', selectedCurrency);
                
                document.getElementById('currentBtcPrice').textContent = price.toFixed(2);
                return price;
            } catch (error) {
                console.error('获取BTC价格失败:', error);
                alert('获取BTC价格失败，请检查网络连接后重试');
                return null;
            }
        }
        
        // 点击刷新价格按钮
        refreshPriceBtn.addEventListener('click', fetchBtcPrice);
        
        // 获取当前价格并填入输入框
        getCurrentPriceBtn.addEventListener('click', function() {
            // 如果已经有当前价格，直接使用它
            const currentPrice = document.getElementById('currentBtcPrice').textContent;
            if (currentPrice && currentPrice !== '--' && !isNaN(parseFloat(currentPrice))) {
                document.getElementById('btcPrice').value = parseFloat(currentPrice);
            } else {
                // 否则重新获取价格
                fetchBtcPrice().then(price => {
                    if (price) {
                        document.getElementById('btcPrice').value = price;
                    }
                });
            }
        });
        
        // 显示现有记录
        function displayRecords() {
            recordList.innerHTML = '';
            
            const currentBtcPrice = parseFloat(document.getElementById('currentBtcPrice').textContent) || 0;
            if (isNaN(currentBtcPrice) || currentBtcPrice === 0) {
                // 如果没有当前价格，尝试获取
                fetchBtcPrice();
            }
            
            console.log("当前BTC价格:", currentBtcPrice, "货币:", selectedCurrency);
            
            records.forEach((record, index) => {
                // 根据当前选择的货币转换金额
                let displayAmount = record.amount;
                let displayBtcPrice = record.btcPrice;
                
                // 如果记录的货币与当前选择的货币不同，进行转换
                if (record.currency && record.currency !== selectedCurrency) {
                    if (record.currency === 'USD' && selectedCurrency === 'CNY') {
                        displayAmount = record.amount * exchangeRates.USD_TO_CNY;
                        displayBtcPrice = record.btcPrice * exchangeRates.USD_TO_CNY;
                    } else if (record.currency === 'CNY' && selectedCurrency === 'USD') {
                        displayAmount = record.amount * exchangeRates.CNY_TO_USD;
                        displayBtcPrice = record.btcPrice * exchangeRates.CNY_TO_USD;
                    }
                }
                
                const row = document.createElement('tr');
                
                // 日期
                const dateCell = document.createElement('td');
                // 格式化日期
                const recordDate = new Date(record.date);
                dateCell.textContent = recordDate.toLocaleString('zh-CN');
                row.appendChild(dateCell);
                
                // 买入金额
                const amountCell = document.createElement('td');
                amountCell.textContent = displayAmount.toFixed(2);
                row.appendChild(amountCell);
                
                // 买入时BTC价格
                const priceCell = document.createElement('td');
                priceCell.textContent = displayBtcPrice.toFixed(2);
                row.appendChild(priceCell);
                
                // 买入数量 (BTC数量不会因货币变化而变化)
                const btcAmountCell = document.createElement('td');
                const btcAmount = record.amount / record.btcPrice;
                btcAmountCell.textContent = btcAmount.toFixed(8);
                row.appendChild(btcAmountCell);
                
                // 备注
                const noteCell = document.createElement('td');
                noteCell.textContent = record.note || '-';
                row.appendChild(noteCell);
                
                // 当前价值 (需要使用正确的当前BTC价格)
                const currentValueCell = document.createElement('td');
                // 计算：BTC数量 × 当前BTC价格
                const currentValue = btcAmount * currentBtcPrice;
                console.log(`记录${index}计算当前价值: ${btcAmount} BTC * ${currentBtcPrice} ${selectedCurrency}/BTC = ${currentValue} ${selectedCurrency}`);
                currentValueCell.textContent = currentValue.toFixed(2);
                row.appendChild(currentValueCell);
                
                // 收益率
                const profitPercentageCell = document.createElement('td');
                // 计算：(当前价值 - 买入显示金额) / 买入显示金额
                const profit = currentValue - displayAmount;
                const profitPercentage = (profit / displayAmount * 100);
                profitPercentageCell.textContent = profitPercentage.toFixed(2) + '%';
                profitPercentageCell.className = profit >= 0 ? 'positive' : 'negative';
                row.appendChild(profitPercentageCell);
                
                // 操作按钮
                const actionCell = document.createElement('td');
                
                // 编辑按钮
                const editButton = document.createElement('button');
                editButton.textContent = '编辑';
                editButton.className = 'secondary';
                editButton.style.padding = '5px 10px';
                editButton.style.marginRight = '5px';
                editButton.addEventListener('click', () => openEditModal(index));
                actionCell.appendChild(editButton);
                
                // 删除按钮
                const deleteButton = document.createElement('button');
                deleteButton.textContent = '删除';
                deleteButton.className = 'danger';
                deleteButton.style.padding = '5px 10px';
                deleteButton.addEventListener('click', () => deleteRecord(index));
                actionCell.appendChild(deleteButton);
                
                row.appendChild(actionCell);
                
                recordList.appendChild(row);
            });
            
            // 计算并显示统计数据
            calculateStatistics();
        }
        
        // 删除单条记录
        function deleteRecord(index) {
            if (confirm('确定要删除这条记录吗？')) {
                records.splice(index, 1);
                localStorage.setItem('investmentRecords', JSON.stringify(records));
                displayRecords();
            }
        }
        
        // 计算并显示统计数据
        function calculateStatistics() {
            let totalInvestment = 0;
            let totalBtc = 0;
            let totalCurrentValue = 0;
            let totalAmounts = 0;    // 用于计算买入金额均价
            let totalBtcPrices = 0;  // 用于计算BTC价格均价
            let totalReturnRates = 0; // 用于计算平均收益率
            
            // 获取当前BTC价格
            const currentBtcPrice = parseFloat(document.getElementById('currentBtcPrice').textContent) || 0;
            console.log("统计中的当前BTC价格:", currentBtcPrice, "货币:", selectedCurrency);
            
            // 如果没有记录，直接返回
            if (records.length === 0) {
                document.getElementById('totalInvestment').textContent = '0.00';
                document.getElementById('totalBtc').textContent = '0.00000000';
                document.getElementById('totalCurrentValue').textContent = '0.00';
                document.getElementById('totalProfit').textContent = '0.00';
                document.getElementById('totalProfitPercentage').textContent = '0.00%';
                document.getElementById('averageAmount').textContent = '0.00';
                document.getElementById('averageBtcPrice').textContent = '0.00';
                document.getElementById('averageReturnRate').textContent = '0.00%';
                return;
            }
            
            records.forEach(record => {
                // 根据当前选择的货币转换金额
                let displayAmount = record.amount;
                let displayBtcPrice = record.btcPrice;
                
                // 如果记录的货币与当前选择的货币不同，进行转换
                if (record.currency && record.currency !== selectedCurrency) {
                    if (record.currency === 'USD' && selectedCurrency === 'CNY') {
                        displayAmount = record.amount * exchangeRates.USD_TO_CNY;
                        displayBtcPrice = record.btcPrice * exchangeRates.USD_TO_CNY;
                    } else if (record.currency === 'CNY' && selectedCurrency === 'USD') {
                        displayAmount = record.amount * exchangeRates.CNY_TO_USD;
                        displayBtcPrice = record.btcPrice * exchangeRates.CNY_TO_USD;
                    }
                }
                
                // 计算总投资额 (使用转换后的金额)
                totalInvestment += displayAmount;
                
                // 计算总BTC数量 (BTC数量不受货币转换影响)
                const btcAmount = record.amount / record.btcPrice;
                totalBtc += btcAmount;
                
                // 累加买入金额和BTC价格，用于计算均价
                totalAmounts += displayAmount;
                totalBtcPrices += displayBtcPrice;
                
                // 计算当前总价值 (BTC数量 × 当前BTC价格)
                const currentValue = btcAmount * currentBtcPrice;
                totalCurrentValue += currentValue;
                
                // 计算单笔收益率 ((当前价值 - 买入显示金额) / 买入显示金额)
                const returnRate = (currentValue - displayAmount) / displayAmount * 100;
                totalReturnRates += returnRate;
            });
            
            // 计算总收益和收益率
            const totalProfit = totalCurrentValue - totalInvestment;
            const totalProfitPercentage = totalInvestment > 0 ? (totalProfit / totalInvestment * 100) : 0;
            
            // 计算均价和平均收益率
            const averageAmount = totalAmounts / records.length;
            const averageBtcPrice = totalBtcPrices / records.length;
            const averageReturnRate = totalReturnRates / records.length;
            
            // 输出统计结果日志
            console.log(`========== 统计结果(${selectedCurrency}) ==========`);
            console.log(`总投资额: ${totalInvestment.toFixed(2)} ${selectedCurrency}`);
            console.log(`总BTC数量: ${totalBtc.toFixed(8)} BTC`);
            console.log(`当前总价值: ${totalCurrentValue.toFixed(2)} ${selectedCurrency}`);
            console.log(`总收益: ${totalProfit.toFixed(2)} ${selectedCurrency} (${totalProfitPercentage.toFixed(2)}%)`);
            console.log(`平均买入金额: ${averageAmount.toFixed(2)} ${selectedCurrency}`);
            console.log(`平均BTC价格: ${averageBtcPrice.toFixed(2)} ${selectedCurrency}/BTC`);
            console.log(`平均收益率: ${averageReturnRate.toFixed(2)}%`);
            console.log(`==========================================`);
            
            // 更新统计显示
            document.getElementById('totalInvestment').textContent = totalInvestment.toFixed(2);
            document.getElementById('totalBtc').textContent = totalBtc.toFixed(8);
            document.getElementById('totalCurrentValue').textContent = totalCurrentValue.toFixed(2);
            document.getElementById('totalProfit').textContent = totalProfit.toFixed(2);
            document.getElementById('totalProfitPercentage').textContent = totalProfitPercentage.toFixed(2) + '%';
            
            // 更新新增的统计指标
            document.getElementById('averageAmount').textContent = averageAmount.toFixed(2);
            document.getElementById('averageBtcPrice').textContent = averageBtcPrice.toFixed(2);
            document.getElementById('averageReturnRate').textContent = averageReturnRate.toFixed(2) + '%';
            
            // 根据收益为正负设置颜色
            document.getElementById('totalProfit').className = 'stat-value ' + (totalProfit >= 0 ? 'positive' : 'negative');
            document.getElementById('totalProfitPercentage').className = 'stat-value ' + (totalProfit >= 0 ? 'positive' : 'negative');
            document.getElementById('averageReturnRate').className = 'stat-value ' + (averageReturnRate >= 0 ? 'positive' : 'negative');
        }
        
        // 保存新记录
        saveBtn.addEventListener('click', () => {
            const date = dateInput.value;
            const amount = parseFloat(amountInput.value);
            const btcPrice = parseFloat(btcPriceInput.value);
            const note = noteInput.value;
            
            if (!date || isNaN(amount) || amount <= 0 || isNaN(btcPrice) || btcPrice <= 0) {
                alert('请填写有效的日期、金额和价格！');
                return;
            }
            
            const newRecord = {
                date: date,
                amount: amount,
                btcPrice: btcPrice,
                note: note,
                currency: selectedCurrency // 保存记录时的货币类型
            };
            
            records.push(newRecord);
            
            // 保存到localStorage
            localStorage.setItem('investmentRecords', JSON.stringify(records));
            
            // 添加调试输出
            console.log('保存记录：', newRecord);
            console.log('所有记录：', records);
            
            // 更新显示
            displayRecords();
            
            // 清空输入框
            dateInput.value = `${year}-${month}-${day}T${hours}:${minutes}`;
            amountInput.value = '';
            btcPriceInput.value = '';
            noteInput.value = '';
        });
        
        // 清空所有记录
        clearBtn.addEventListener('click', () => {
            if (confirm('确定要清空所有记录吗？此操作不可恢复！')) {
                records = [];
                localStorage.removeItem('investmentRecords');
                displayRecords();
            }
        });
        
        // 导出数据
        exportBtn.addEventListener('click', () => {
            if (records.length === 0) {
                alert('没有可导出的记录！');
                return;
            }
            
            const dataStr = JSON.stringify(records, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.setAttribute('href', url);
            a.setAttribute('download', 'btc_investment_records.json');
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        });
        
        // 导入数据
        importBtn.addEventListener('click', () => {
            importFile.click();
        });
        
        importFile.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedRecords = JSON.parse(e.target.result);
                    
                    if (Array.isArray(importedRecords)) {
                        if (confirm(`确定要导入 ${importedRecords.length} 条记录吗？这将替换当前所有记录。`)) {
                            records = importedRecords;
                            localStorage.setItem('investmentRecords', JSON.stringify(records));
                            displayRecords();
                            alert('数据导入成功！');
                        }
                    } else {
                        alert('导入失败：数据格式不正确！');
                    }
                } catch (error) {
                    alert('导入失败：无法解析文件内容！');
                    console.error('导入错误:', error);
                }
                
                // 清空文件输入，以便可以再次选择同一文件
                importFile.value = '';
            };
            reader.readAsText(file);
        });
        
        // 打开编辑记录的弹窗
        function openEditModal(index) {
            const record = records[index];
            
            // 设置表单的初始值
            editDateInput.value = record.date;
            
            // 根据记录的货币和当前选择的货币设置金额和价格
            if (record.currency === selectedCurrency) {
                // 如果记录的货币与当前选择的货币相同，直接使用原始值
                editAmountInput.value = record.amount;
                editBtcPriceInput.value = record.btcPrice;
            } else {
                // 如果不同，需要转换
                if (record.currency === 'USD' && selectedCurrency === 'CNY') {
                    editAmountInput.value = (record.amount * exchangeRates.USD_TO_CNY).toFixed(2);
                    editBtcPriceInput.value = (record.btcPrice * exchangeRates.USD_TO_CNY).toFixed(2);
                } else if (record.currency === 'CNY' && selectedCurrency === 'USD') {
                    editAmountInput.value = (record.amount * exchangeRates.CNY_TO_USD).toFixed(2);
                    editBtcPriceInput.value = (record.btcPrice * exchangeRates.CNY_TO_USD).toFixed(2);
                }
            }
            
            editNoteInput.value = record.note || '';
            editRecordIndexInput.value = index;
            
            // 更新弹窗中的货币标签
            document.getElementById('edit-currency-symbol').textContent = selectedCurrency;
            document.getElementById('edit-price-currency-symbol').textContent = selectedCurrency;
            
            // 显示弹窗
            editModal.style.display = 'block';
        }
        
        // 关闭编辑弹窗
        function closeEditModal() {
            editModal.style.display = 'none';
        }
        
        // 保存编辑后的记录
        function saveEditedRecord() {
            const index = parseInt(editRecordIndexInput.value);
            const date = editDateInput.value;
            const amount = parseFloat(editAmountInput.value);
            const btcPrice = parseFloat(editBtcPriceInput.value);
            const note = editNoteInput.value;
            
            if (!date || isNaN(amount) || amount <= 0 || isNaN(btcPrice) || btcPrice <= 0) {
                alert('请填写有效的日期、金额和价格！');
                return;
            }
            
            // 创建更新后的记录
            const updatedRecord = {
                date: date,
                amount: amount,
                btcPrice: btcPrice,
                note: note,
                currency: selectedCurrency // 使用当前选择的货币
            };
            
            // 更新记录
            records[index] = updatedRecord;
            
            // 保存到localStorage
            localStorage.setItem('investmentRecords', JSON.stringify(records));
            
            // 添加调试输出
            console.log('编辑记录：', updatedRecord);
            console.log('所有记录：', records);
            
            // 关闭弹窗并更新显示
            closeEditModal();
            displayRecords();
        }
        
        // 绑定编辑弹窗的事件
        saveEditBtn.addEventListener('click', saveEditedRecord);
        cancelEditBtn.addEventListener('click', closeEditModal);
        closeModalBtn.addEventListener('click', closeEditModal);
        
        // 点击弹窗外部关闭弹窗
        window.addEventListener('click', (event) => {
            if (event.target === editModal) {
                closeEditModal();
            }
        });
        
        // 页面加载时初始化
        window.addEventListener('DOMContentLoaded', async () => {
            // 先获取最新汇率，如果失败则使用默认值
            await fetchExchangeRate();
            
            // 设置日期默认值
            updateCurrencyLabels();
            
            // 获取BTC价格
            fetchBtcPrice().then(() => {
                // 显示记录
                displayRecords();
            });
        });
    </script>
</body>
</html>
